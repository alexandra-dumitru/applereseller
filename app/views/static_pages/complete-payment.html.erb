<script>
	jQuery("document").ready(function($) {
		var orderData = {
			model: "<%= session[:model] %>",
			size: "<%= session[:size] %>",
			color: "<%= session[:color] %>",
			price: "<%= session[:price] %>",
			promocode: null,
			itunesCodes: null
		}

		console.log(orderData)

	  $("#promocode-input-iphone-7").change(function(){
	    var userInput = $(this).val();
	    $.ajax({
	      type: "GET",
	      url: "/promocodes",
	      dataType: "json",
	      beforeSend: function() {
	        $('#loading-image-promocode-7').show();
	        $("#checkmark-positive-7").hide();
	        $("#checkmark-negative-7").hide();
	      },
	      success: function(data){
	        var check = false;
	         data.filter(function(key){
	            if(key.promovalue == userInput){
	              check = true;
	              orderData["promocode"] = key.promovalue;
	              $('#loading-image-promocode-7').hide();
	              $("#checkmark-positive-7").show();
	              $("#checkmark-negative-7").hide();
	              if(orderData["price"] != null){
	                var discount = orderData["price"] - orderData["price"] * (key.promotype * 0.01);
	                orderData["price"] = discount;
	                $("#price-iphone-7").text("New price: $" + discount);
	              }
	              else {
	                $("#error_modal_promocode").modal("toggle");
	              }
	            }
	         });
	         if(check == false) {
	          $('#loading-image-promocode-7').hide();
	          $("#checkmark-positive-7").hide();
	          $("#checkmark-negative-7").show();
	         }
	      }
	    });
	  });

	  var nextInput = 1;
	  var maxCodes = 8;
	  var htmlSource = 
	  '<div id="form_code_{{id}}">'+
	    '<div class="col-md-4 col-md-offset-4">'+
	      '<input autocomplete="off" id="code_{{id}}" name="code_{{id}}" class="input form-control" placeholder="Add code here" type="text"><span class="errmsg" style="color:red"></span>'+
	    '</div>'+
	    '<div class="col-md-1 form-code-add">'+
	      '<button class="btn add-more btn-default" type="button">+</button>'+
	    '</div>'+
	    '<div class="col-md-1 form-code-remove">'+
	      '<button class="btn remove-me btn-danger" type="button">-</button>'+
	    '</div>'+
	  '</div>';

	  var appendFields = $("#fields-append");

	  appendFields.on("click", "button.add-more", function(e) {

	    e.preventDefault();

	    nextInput++;

	    appendFields.find("button.add-more, button.remove-me").remove();

	    appendFields.append(htmlSource.replace(/{{id}}/g, nextInput));

	  }).on("click", "button.remove-me", function(e) {

	    e.preventDefault();

	    $("#form_code_" + nextInput).remove();

	    nextInput--;
	    
	    if (nextInput === 1) {

	      $("#form_code_"+nextInput).find(".form-code-add").append('<button class="btn btn-default add-more" type="button">+</button>');
	    } else {

	      $("#form_code_"+nextInput).find(".form-code-remove").append('<button class="btn remove-me btn-danger" type="button">-</button>').end().find(".form-code-add").append('<button class="btn btn-default add-more" type="button">+</button>');
	    }

	  });

	  $("#fields-append input").each(function() {
	    $(this).keypress(function(key){
	      if((key.which != 8) && (key.which != 0) && (key.which < 48 || key.which > 57)){
	        $(".errmsg").html("Digits Only").show().fadeOut("slow");
	          return false;
	      }
	    });
	  });

	}); // document ready end
</script>


<div class="jumbotron center">
<h1 id="testPost">Order data: <%= session[:model] + " " + session[:size] + " " + session[:color] + " " + session[:price]%></h1>
<br>


 <!-- PROMOCODE -->

  <div class="lead">
    Promocode
  </div>

  <div id="promocode-iphone-7" class="row form-horizontal">
    <div class="col-md-4 col-md-offset-4">
      <input type="text" class="form-control" id="promocode-input-iphone-7" placeholder="Promocode">
      <br>
      <div id="price-iphone-7" class="price-area"></div>
    </div>
    <div class="col-md-1">
      <div id="loading-image-promocode-7" style='display:none'>
        <%= image_tag("loading.gif", alt: "Loading", size: "20x20")%>
      </div>
      <span id="checkmark-positive-7" class="checkmark-positive" style="display:none">&#10004;</span>
      <span id="checkmark-negative-7" class="checkmark-negative" title="Promocode is not valid!" style="display:none">x</span>
    </div>
  </div>
  <br>

<!-- iTunes Gift Cards -->

  <div class="lead">
    iTunes gift card 16 digit codes
  </div>

  <div class="row form-horizontal" id="fields-append">
    <div id="form_code_1">
      <div class="col-md-4 col-md-offset-4">
        <input autocomplete="off" class="input form-control" type="text" placeholder="Add code here" /><span class="errmsg" style="color:red"></span>
      </div>
      <div class="col-md-1 form-code-add">
        <button class="btn add-more btn-default" type="button">+</button>
      </div>
      <div class="col-md-1 form-code-remove">
      </div>
    </div>
  </div>

  <div class="row">
    <button id="submit7" type="button" class="btn btn-primary btn-lg active">Place order</button>
  </div>
</div>